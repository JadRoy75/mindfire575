<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–µ—Ç–ª—è—á–∫–∏ ‚Äî –î–Ω–µ–≤–Ω–∏–∫ –∏ –ë–∞–Ω–∫–∞</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c1e 0%, #1a1a3e 50%, #0c0c1e 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –§–û–ù –ò –°–í–ï–¢–õ–Ø–ß–ö–ò */
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .star { position: absolute; width: 2px; height: 2px; background: #fff; border-radius: 50%; opacity: 0.5; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.8; } }

        /* –§–æ–Ω–æ–≤—ã–µ —Å–≤–µ—Ç–ª—è—á–∫–∏ (GPU —É—Å–∫–æ—Ä–µ–Ω–∏–µ) */
        .bg-firefly {
            position: absolute;
            width: 8px; height: 8px;
            background: #ffeb3b;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 15px #ffeb3b;
            will-change: transform;
            animation: floatBg 15s linear infinite;
            z-index: 0;
            opacity: 0.4;
        }
        @keyframes floatBg {
            0% { transform: translate3d(0, 0, 0); }
            33% { transform: translate3d(50px, -50px, 0); }
            66% { transform: translate3d(-30px, -100px, 0); }
            100% { transform: translate3d(0, -150px, 0); opacity: 0;}
        }

        .container { position: relative; z-index: 1; max-width: 800px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }

        .screen { display: none; animation: fadeIn 0.3s ease; width: 100%; height: 100%; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        input, textarea { width: 100%; padding: 15px; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.05); color: #fff; font-size: 16px; margin-bottom: 15px; }
        input:focus, textarea:focus { outline: none; border-color: #ffeb3b; }
        .btn { padding: 15px 30px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(45deg, #ffeb3b, #ff9800); color: #1a1a3e; }
        .btn-primary:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }

        /* –ò–ö–û–ù–ö–ò –ù–ê–°–¢–†–û–ï–ù–ò–Ø */
        .svg-icon { width: 40px; height: 40px; stroke-width: 2; fill: none; transition: 0.3s; }
        .mood-red { stroke: #ff5252; color: #ff5252; }
        .mood-orange { stroke: #ff9800; color: #ff9800; }
        .mood-yellow { stroke: #ffeb3b; color: #ffeb3b; }
        .mood-lime { stroke: #c6ff00; color: #c6ff00; }
        .mood-green { stroke: #00e676; color: #00e676; }

        .mood-grid { display: flex; justify-content: space-between; gap: 10px; margin-top: 30px; }
        .mood-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.3s; padding: 10px; border-radius: 15px; }
        .mood-item:hover { background: rgba(255,255,255,0.05); transform: translateY(-5px); }
        .mood-label { font-size: 14px; color: rgba(255,255,255,0.7); margin-top: 10px; }

        /* --- –ì–ò–ì–ê–ù–¢–°–ö–ò–ï –°–í–ï–¢–õ–Ø–ß–ö–ò (–£–í–ï–õ–ò–ß–ï–ù–´ –ù–ê 30%) --- */
        .choice-container { display: flex; justify-content: center; align-items: center; gap: 100px; height: 70vh; }
        
        .giant-firefly {
            position: relative;
            width: 260px; /* –ë—ã–ª–æ 200 */
            height: 380px; /* –ë—ã–ª–æ 300 */
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .giant-firefly:hover { transform: scale(1.05); z-index: 10; }

        /* –ö—Ä—ã–ª—å—è */
        .ff-wings { position: absolute; top: 75px; width: 200px; height: 150px; background: rgba(255, 255, 255, 0.1); border-radius: 50% 50% 10px 10px; backdrop-filter: blur(5px); transition: 0.3s; z-index: 1; transform-origin: top center; border: 1px solid rgba(255,255,255,0.2); }
        .giant-firefly:hover .ff-wings { width: 230px; transform: scaleX(1.1); background: rgba(255, 255, 255, 0.15); }

        /* –ì–æ–ª–æ–≤–∞ */
        .ff-head { width: 75px; height: 75px; background: #2a2a5e; border-radius: 50%; z-index: 2; position: relative; border: 2px solid rgba(255,255,255,0.1); box-shadow: inset 0 -5px 10px rgba(0,0,0,0.5); }
        
        /* –ì–ª–∞–∑–∫–∏ */
        .ff-head::before, .ff-head::after { content: ''; position: absolute; top: 25px; width: 10px; height: 10px; background: #fff; border-radius: 50%; }
        .ff-head::before { left: 18px; } .ff-head::after { right: 18px; }

        /* –ü—É–∑–∏–∫–æ */
        .ff-belly {
            width: 130px; height: 180px; background: rgba(50,50,50,0.8); border-radius: 65px;
            margin-top: -10px; z-index: 2; transition: all 0.5s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden; position: relative;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .ff-title { font-weight: bold; font-size: 22px; color: #fff; transition: 0.3s; z-index: 3; text-transform: uppercase; }
        .ff-desc { font-size: 14px; color: #1a1a3e; opacity: 0; text-align: center; padding: 0 10px; transition: 0.5s; margin-top: 5px; z-index: 3; font-weight: 500;}

        /* –°–≤–µ—á–µ–Ω–∏–µ */
        .ff-color-blue:hover .ff-belly { background: #6dd5ed; box-shadow: 0 0 50px #6dd5ed; border-color: #6dd5ed;}
        .ff-color-blue:hover .ff-title { color: #1a1a3e; }
        .ff-color-blue:hover .ff-desc { opacity: 1; }

        .ff-color-yellow:hover .ff-belly { background: #ffeb3b; box-shadow: 0 0 50px #ffeb3b; border-color: #ffeb3b;}
        .ff-color-yellow:hover .ff-title { color: #1a1a3e; }
        .ff-color-yellow:hover .ff-desc { opacity: 1; }

        .ff-color-green:hover .ff-belly { background: #00e676; box-shadow: 0 0 50px #00e676; border-color: #00e676;}
        .ff-color-green:hover .ff-title { color: #1a1a3e; }
        .ff-color-green:hover .ff-desc { opacity: 1; }

        /* –ö–ê–õ–ï–ù–î–ê–†–¨ –ù–ê–°–¢–†–û–ï–ù–ò–ô */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
        .cal-day { background: rgba(255,255,255,0.05); padding: 5px; min-height: 50px; border-radius: 8px; font-size: 12px; color: rgba(255,255,255,0.5); position: relative; }
        .cal-day-name { text-align: center; color: rgba(255,255,255,0.3); font-size: 10px; margin-bottom: 5px;}
        .cal-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; }

        /* –ë–ê–ù–ö–ê */
        .jar-container { position: relative; width: 240px; height: 300px; margin: 30px auto; }
        .jar-body { position: absolute; bottom: 0; left: 0; width: 100%; height: 260px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(4px); border: 2px solid rgba(255,255,255,0.2); border-top: none; border-radius: 20px 20px 60px 60px; overflow: hidden; }
        .jar-lid { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 150px; height: 35px; background: #5d4037; border-radius: 8px 8px 4px 4px; border: 1px solid rgba(255,255,255,0.1); z-index: 2; }
        
        .firefly { position: absolute; width: 10px; height: 10px; border-radius: 50%; animation: float 4s infinite ease-in-out; cursor: pointer; will-change: transform; transition: 0.2s; }
        .firefly:hover { transform: scale(1.5); }
        .firefly::after { content: ''; position: absolute; width: 200%; height: 200%; background: inherit; filter: blur(5px); top: -50%; left: -50%; opacity: 0.6; border-radius: 50%; pointer-events: none; }
        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(10px, -15px); } }

        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1a1a3e; width: 90%; max-width: 500px; padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); max-height: 85vh; overflow-y: auto; position: relative; }

        .tags-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag { padding: 5px 12px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); font-size: 12px; cursor: pointer; transition: 0.2s;}
        .tag.selected { background: #ffeb3b; color: #000; border-color: #ffeb3b; }

        /* –í–´–ë–û–† –¶–í–ï–¢–ê */
        .color-picker-grid { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;}
        .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .color-dot:hover, .color-dot.selected { transform: scale(1.2); border-color: #fff; }
        .color-input-wrapper { position: relative; width: 30px; height: 30px; border-radius: 50%; overflow: hidden; cursor: pointer; border: 2px dashed rgba(255,255,255,0.5); }
        .color-input-wrapper input { position: absolute; top: -10px; left: -10px; width: 50px; height: 50px; border: none; cursor: pointer; background: transparent; }

        /* –§–æ—Ç–æ-–ø—Ä–µ–≤—å—é */
        .img-preview { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 10px; display: none; object-fit: cover; }

        .diary-layout { display: grid; grid-template-columns: 250px 1fr; gap: 20px; margin-top: 20px;}
        .diary-nav { background: rgba(255,255,255,0.03); border-radius: 16px; padding: 10px; }
        .nav-item { padding: 15px; border-radius: 8px; cursor: pointer; color: rgba(255,255,255,0.6); margin-bottom: 5px; transition: 0.2s;}
        .nav-item.active, .nav-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .diary-tab { display: none; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 16px; }
        .diary-tab.active { display: block; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .achieve-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; text-align: center; }

        .back-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 16px; margin-bottom: 20px; }
        .back-btn:hover { color: #fff; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ */
        .export-card { background: linear-gradient(135deg, #1a1a3e, #2a2a5e); padding: 25px; border-radius: 16px; position: relative; }
        .export-img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <div class="container">
        
        <div class="screen active" id="authChoiceScreen">
            <h1 style="text-align: center; margin-top: 50px; font-size: 36px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
            <p style="text-align: center; color: #888; margin-bottom: 40px;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</p>
            
            <div class="choice-container" style="height: auto; margin-top: 20px;">
                <div class="giant-firefly ff-color-green" onclick="showAuthForm('login')">
                    <div class="ff-head"></div>
                    <div class="ff-wings"></div>
                    <div class="ff-belly">
                        <span class="ff-title">–í–•–û–î</span>
                        <span class="ff-desc">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–≤–æ–∏–º –∑–∞–ø–∏—Å—è–º</span>
                    </div>
                </div>

                <div class="giant-firefly ff-color-yellow" onclick="showAuthForm('register')">
                    <div class="ff-head"></div>
                    <div class="ff-wings"></div>
                    <div class="ff-belly">
                        <span class="ff-title">–ù–û–í–´–ô</span>
                        <span class="ff-desc">–°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –±–∞–Ω–∫—É</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen" id="authFormScreen">
            <button class="back-btn" onclick="showScreen('authChoiceScreen')">‚Üê –ù–∞–∑–∞–¥</button>
            <div style="max-width: 400px; margin: 50px auto; background: rgba(255,255,255,0.03); padding: 30px; border-radius: 20px;">
                <h2 id="authFormTitle" style="text-align: center; margin-bottom: 20px;">–í—Ö–æ–¥</h2>
                <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è">
                <input type="password" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="btn btn-primary" style="width: 100%;" onclick="showMoodScreen()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
        </div>

        <div class="screen" id="moodScreen">
            <div style="text-align: center; max-width: 600px; margin: auto; padding-top: 15vh;">
                <h2 style="font-size: 24px;">–ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–≥–æ–¥–Ω—è, <span id="userNameLabel"></span>?</h2>
                <div class="mood-grid">
                    <div class="mood-item" onclick="saveMood('–æ—á–µ–Ω—å –ø–ª–æ—Ö–æ', '#ff5252')">
                        <svg class="svg-icon mood-red" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 9h.01M16 9h.01M8 16s1-2 4-2 4 2 4 2"></path></svg>
                        <span class="mood-label">–û—á–µ–Ω—å –ø–ª–æ—Ö–æ</span>
                    </div>
                    <div class="mood-item" onclick="saveMood('–ø–ª–æ—Ö–æ', '#ff9800')">
                        <svg class="svg-icon mood-orange" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 9h.01M16 9h.01M8 15h8"></path></svg>
                        <span class="mood-label">–ü–ª–æ—Ö–æ</span>
                    </div>
                    <div class="mood-item" onclick="saveMood('–Ω–æ—Ä–º–∞–ª—å–Ω–æ', '#ffeb3b')">
                        <svg class="svg-icon mood-yellow" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 9h.01M16 9h.01M9 15s1 1 3 1 3-1 3-1"></path></svg>
                        <span class="mood-label">–ù–æ—Ä–º–∞–ª—å–Ω–æ</span>
                    </div>
                    <div class="mood-item" onclick="saveMood('—Ö–æ—Ä–æ—à–æ', '#c6ff00')">
                        <svg class="svg-icon mood-lime" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2M8 9h.01M16 9h.01"></path></svg>
                        <span class="mood-label">–•–æ—Ä–æ—à–æ</span>
                    </div>
                    <div class="mood-item" onclick="saveMood('–æ—Ç–ª–∏—á–Ω–æ', '#00e676')">
                        <svg class="svg-icon mood-green" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 3 4 3 4-3 4-3M8 9h.01M16 9h.01"></path></svg>
                        <span class="mood-label">–û—Ç–ª–∏—á–Ω–æ</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen" id="mainChoiceScreen">
            <h2 style="text-align: center; margin-top: 50px;">–ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏–º—Å—è?</h2>
            
            <div class="choice-container">
                <div class="giant-firefly ff-color-blue" onclick="showScreen('diaryScreen')">
                    <div class="ff-head"></div>
                    <div class="ff-wings"></div>
                    <div class="ff-belly">
                        <span class="ff-title">–î–ù–ï–í–ù–ò–ö</span>
                        <span class="ff-desc">–ú–µ—Å—Ç–æ –¥–ª—è –º—ã—Å–ª–µ–π –∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏</span>
                    </div>
                </div>

                <div class="giant-firefly ff-color-yellow" onclick="showScreen('jarScreen')">
                    <div class="ff-head"></div>
                    <div class="ff-wings"></div>
                    <div class="ff-belly">
                        <span class="ff-title">–ë–ê–ù–ö–ê</span>
                        <span class="ff-desc">–•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–≤–µ—Ç–ª—ã—Ö –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen" id="jarScreen">
            <button class="back-btn" onclick="showScreen('mainChoiceScreen')">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É</button>
            <h2 style="text-align: center;">–ë–∞–Ω–∫–∞ —Å–≤–µ—Ç–ª—è—á–∫–æ–≤</h2>

            <div class="jar-container">
                <div class="jar-lid"></div>
                <div class="jar-body">
                    <div class="fireflies-container" id="firefliesContainer"></div>
                </div>
            </div>

            <div style="text-align: center; display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="openAddMomentModal()">+ –ü–æ–π–º–∞—Ç—å –º–æ–º–µ–Ω—Ç</button>
                <button class="btn btn-secondary" onclick="showRandomHappyMoment()">–ú–Ω–µ –≥—Ä—É—Å—Ç–Ω–æ üåßÔ∏è</button>
            </div>
        </div>

        <div class="screen" id="diaryScreen">
            <button class="back-btn" onclick="showScreen('mainChoiceScreen')">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É</button>
            <h2>–î–Ω–µ–≤–Ω–∏–∫ –º—ã—Å–ª–µ–π</h2>

            <div class="diary-layout">
                <div class="diary-nav">
                    <div class="nav-item active" onclick="switchTab('create')">‚úèÔ∏è –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</div>
                    <div class="nav-item" onclick="switchTab('list')">üìñ –ú–æ–∏ –∑–∞–ø–∏—Å–∏</div>
                    <div class="nav-item" onclick="switchTab('achieve')">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                    <div class="nav-item" onclick="switchTab('profile')">üìä –ü—Ä–æ—Ñ–∏–ª—å –∏ –î–∏–Ω–∞–º–∏–∫–∞</div>
                </div>

                <div>
                    <div id="tab-create" class="diary-tab active">
                        <input type="text" id="entryTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
                        <textarea id="entryContent" rows="8" placeholder="–û —á–µ–º –¥—É–º–∞–µ—à—å?"></textarea>
                        <input type="text" id="entryTags" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
                        
                        <div style="margin-bottom: 15px;">
                            <label style="color: #888; font-size: 14px; margin-bottom: 5px; display: block;">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                            <input type="file" id="entryFile" accept="image/*" onchange="previewImage(this, 'entryImgPreview')">
                            <img id="entryImgPreview" class="img-preview" src="" alt="preview">
                        </div>

                        <button class="btn btn-primary" onclick="saveEntry()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                    </div>

                    <div id="tab-list" class="diary-tab">
                        <input type="text" id="searchEntries" placeholder="–ü–æ–∏—Å–∫..." oninput="renderEntries()">
                        <div id="entriesList"></div>
                    </div>

                    <div id="tab-achieve" class="diary-tab">
                        <div class="stat-grid" id="achievementsList"></div>
                    </div>

                    <div id="tab-profile" class="diary-tab">
                        <h3 id="statTotalMoments">–í—Å–µ–≥–æ —Å–≤–µ—Ç–ª—è—á–∫–æ–≤: 0</h3>
                        <h3 id="statTotalEntries" style="margin-top: 5px;">–ó–∞–ø–∏—Å–µ–π –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ: 0</h3>
                        
                        <h3 style="margin-top: 20px; margin-bottom: 10px;">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π</h3>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: #888;">
                            <span>–ü–Ω</span><span>–í—Ç</span><span>–°—Ä</span><span>–ß—Ç</span><span>–ü—Ç</span><span>–°–±</span><span>–í—Å</span>
                        </div>
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="addMomentModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 15px;">–ù–æ–≤—ã–π —Å–≤–µ—Ç–ª—è—á–æ–∫</h2>
            <textarea id="momentText" rows="3" placeholder="–ß—Ç–æ —Ö–æ—Ä–æ—à–µ–≥–æ —Å–ª—É—á–∏–ª–æ—Å—å?"></textarea>
            
            <p style="margin-bottom: 10px; color: #888; font-size: 14px;">–§–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</p>
            <input type="file" id="momentFile" accept="image/*" onchange="previewImage(this, 'momentImgPreview')">
            <img id="momentImgPreview" class="img-preview" src="" alt="preview">

            <p style="margin-bottom: 10px; color: #888; font-size: 14px; margin-top: 15px;">–¢–µ–≥–∏:</p>
            <div class="tags-list" id="momentTags">
                <span class="tag" onclick="this.classList.toggle('selected')">–°–µ–º—å—è</span>
                <span class="tag" onclick="this.classList.toggle('selected')">–î—Ä—É–∑—å—è</span>
                <span class="tag" onclick="this.classList.toggle('selected')">–†–∞–±–æ—Ç–∞</span>
                <span class="tag" onclick="this.classList.toggle('selected')">–ü—Ä–∏—Ä–æ–¥–∞</span>
            </div>

            <p style="margin-bottom: 10px; color: #888; font-size: 14px;">–¶–≤–µ—Ç —Å–≤–µ—á–µ–Ω–∏—è:</p>
            <div class="color-picker-grid">
                <div class="color-dot selected" style="background:#ffeb3b" onclick="selectColor(this, '#ffeb3b')"></div>
                <div class="color-dot" style="background:#4caf50" onclick="selectColor(this, '#4caf50')"></div>
                <div class="color-dot" style="background:#00bcd4" onclick="selectColor(this, '#00bcd4')"></div>
                <div class="color-dot" style="background:#e91e63" onclick="selectColor(this, '#e91e63')"></div>
                <div class="color-dot" style="background:#ff9800" onclick="selectColor(this, '#ff9800')"></div>
                <div class="color-dot" style="background:#9c27b0" onclick="selectColor(this, '#9c27b0')"></div>
                
                <div style="width: 2px; height: 20px; background: rgba(255,255,255,0.2); margin: 0 5px;"></div>
                
                <div class="color-input-wrapper">
                    <input type="color" id="customColorInput" onchange="addCustomColor(this.value)">
                </div>
                <div class="color-dot" id="recentColor1" style="background:transparent; display:none;" onclick="selectColor(this, this.dataset.color)"></div>
                <div class="color-dot" id="recentColor2" style="background:transparent; display:none;" onclick="selectColor(this, this.dataset.color)"></div>
                <div class="color-dot" id="recentColor3" style="background:transparent; display:none;" onclick="selectColor(this, this.dataset.color)"></div>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('addMomentModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveMoment()">–ü–æ–π–º–∞—Ç—å!</button>
            </div>
        </div>
    </div>

    <div class="modal" id="viewMomentModal">
        <div class="modal-content" style="padding: 0;">
            <div id="momentExportArea" class="export-card" style="margin: 0;">
                <div id="viewMomentColor" style="width: 20px; height: 20px; border-radius: 50%; box-shadow: 0 0 15px currentColor; margin: 0 auto 15px;"></div>
                <p id="viewMomentDate" style="color: #888; font-size: 12px; margin-bottom: 15px; text-align: center;"></p>
                <p id="viewMomentText" style="font-size: 18px; line-height: 1.5; margin-bottom: 20px; text-align: center;"></p>
                <img id="viewMomentImg" class="export-img" style="display: none; width: 100%; margin-bottom: 15px;" src="">
                <div id="viewMomentTags" style="display: flex; justify-content: center; gap: 5px; flex-wrap: wrap;"></div>
            </div>
            
            <div style="padding: 20px; display: flex; gap: 10px; justify-content: center; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.05);">
                <button class="btn btn-secondary" onclick="closeModal('viewMomentModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="btn btn-primary" onclick="exportToPNG('momentExportArea', 'memory')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è (PNG)</button>
            </div>
        </div>
    </div>

    <script>
        // –î–ê–ù–ù–´–ï –ò –ö–≠–®
        let appData = {
            user: null,
            moodHistory: {}, 
            moments: [], 
            entries: [], 
            recentColors: [] // –î–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ (–º–∞–∫—Å 3)
        };

        const achievementsList = [
            { id: 'first', icon: 'üåü', title: '–ü–µ—Ä–≤—ã–π —Å–≤–µ—Ç', desc: '–î–æ–±–∞–≤–∏—Ç—å 1 —Å–≤–µ—Ç–ª—è—á–∫–∞', req: () => appData.moments.length >= 1 },
            { id: 'jar50', icon: 'ü´ô', title: '–ü–æ–ª–Ω–∞—è –±–∞–Ω–∫–∞', desc: '50 —Å–≤–µ—Ç–ª—è—á–∫–æ–≤', req: () => appData.moments.length >= 50 },
            { id: 'rainbow', icon: 'üåà', title: '–í—Å—è –ø–∞–ª–∏—Ç—Ä–∞', desc: '–†–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞ —ç–º–æ—Ü–∏–π', req: () => Object.keys(appData.moodHistory).length >= 5 },
            { id: 'generous', icon: 'üéÅ', title: '–©–µ–¥—Ä–∞—è –¥—É—à–∞', desc: '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∑–∞–ø–∏—Å—å—é', req: () => false },
            { id: 'streak', icon: 'üî•', title: '–ù–µ–¥–µ–ª—è —Ç–µ–ø–ª–∞', desc: '7 –¥–Ω–µ–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è', req: () => Object.keys(appData.moodHistory).length >= 7 },
            { id: 'comeback', icon: 'üí™', title: '–í—ã–∫–∞—Ä–∞–±–∫–∞–ª—Å—è', desc: '–ò–∑ –ø–ª–æ—Ö–æ–≥–æ –≤ —Ö–æ—Ä–æ—à–µ–µ', req: () => false },
            { id: 'writer', icon: 'üìñ', title: '–°—Ü–µ–Ω–∞—Ä–∏—Å—Ç', desc: '–ù–∞–ø–∏—Å–∞—Ç—å 5 –∑–∞–ø–∏—Å–µ–π –≤ –¥–Ω–µ–≤–Ω–∏–∫', req: () => appData.entries.length >= 5 },
            { id: 'sage', icon: 'üßò', title: '–ú—É–¥—Ä–µ—Ü', desc: '–ë–æ–ª–µ–µ 1000 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ', req: () => appData.entries.reduce((acc, val) => acc + val.content.length, 0) >= 1000 },
            { id: 'photo', icon: 'üì∑', title: '–§–æ—Ç–æ–≥—Ä–∞—Ñ', desc: '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É', req: () => appData.entries.some(e => e.img) || appData.moments.some(m => m.img) }
        ];

        window.onload = function() {
            createStars();
            createBgFireflies();
            loadData();
            updateRecentColorsUI();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–æ–≤—ã–π –∏–ª–∏ —Å—Ç–∞—Ä—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            if (appData.user) {
                document.getElementById('userNameLabel').textContent = appData.user;
                const today = new Date().toISOString().split('T')[0];
                if (appData.moodHistory[today]) {
                    showScreen('mainChoiceScreen');
                } else {
                    showScreen('moodScreen');
                }
            } else {
                showScreen('authChoiceScreen');
            }
        };

        // –°–û–ó–î–ê–ù–ò–ï –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–• –§–û–ù–û–í–´–• –°–í–ï–¢–õ–Ø–ß–ö–û–í
        function createBgFireflies() {
            const container = document.getElementById('stars');
            for(let i=0; i<15; i++) {
                const ff = document.createElement('div');
                ff.className = 'bg-firefly';
                ff.style.left = Math.random() * 100 + '%';
                ff.style.top = Math.random() * 100 + '%';
                ff.style.animationDuration = (Math.random() * 10 + 10) + 's';
                ff.style.animationDelay = Math.random() * -10 + 's';
                container.appendChild(ff);
            }
        }

        // –ö–≠–®
        function loadData() {
            const saved = localStorage.getItem('fireflies_data');
            if (saved) appData = JSON.parse(saved);
        }

        function saveData() {
            localStorage.setItem('fireflies_data', JSON.stringify(appData));
            updateStats();
        }

        // –ë–ê–ó–û–í–ê–Ø –õ–û–ì–ò–ö–ê UI
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                starsContainer.appendChild(star);
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'jarScreen') renderFireflies();
            if (id === 'diaryScreen') updateStats();
        }

        function showAuthForm(type) {
            document.getElementById('authFormTitle').textContent = type === 'login' ? '–í—Ö–æ–¥' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
            showScreen('authFormScreen');
        }

        function showMoodScreen() {
            const name = document.getElementById('username').value || appData.user || '–ü—É—Ç–Ω–∏–∫';
            appData.user = name;
            document.getElementById('userNameLabel').textContent = name;
            showScreen('moodScreen');
            saveData();
        }

        // –ß–¢–ï–ù–ò–ï –ö–ê–†–¢–ò–ù–û–ö –í BASE64
        function previewImage(input, previewId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(previewId);
                    img.src = e.target.result;
                    img.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        // –¶–í–ï–¢–ê
        let currentSelectedColor = '#ffeb3b';

        function selectColor(element, color) {
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            element.classList.add('selected');
            currentSelectedColor = color;
        }

        function addCustomColor(color) {
            currentSelectedColor = color;
            if (!appData.recentColors.includes(color)) {
                appData.recentColors.unshift(color);
                if (appData.recentColors.length > 3) appData.recentColors.pop();
                saveData();
                updateRecentColorsUI();
            }
            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π
            document.getElementById('recentColor1').click(); 
        }

        function updateRecentColorsUI() {
            appData.recentColors.forEach((color, i) => {
                const dot = document.getElementById('recentColor' + (i + 1));
                if (dot) {
                    dot.style.background = color;
                    dot.dataset.color = color;
                    dot.style.display = 'block';
                }
            });
        }

        // –õ–û–ì–ò–ö–ê –î–ù–ï–í–ù–ò–ö–ê
        function switchTab(tab) {
            document.querySelectorAll('.diary-nav .nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.querySelectorAll('.diary-tab').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');

            if(tab === 'list') renderEntries();
            if(tab === 'achieve') renderAchievements();
            if(tab === 'profile') renderCalendar();
        }

        function saveEntry() {
            const title = document.getElementById('entryTitle').value;
            const text = document.getElementById('entryContent').value;
            const tags = document.getElementById('entryTags').value.split(',').map(t => t.trim()).filter(t => t);
            const imgPreview = document.getElementById('entryImgPreview');
            const imgBase64 = imgPreview.style.display === 'block' ? imgPreview.src : null;

            if (!text) return;

            appData.entries.unshift({
                id: Date.now(),
                title: title || '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞',
                content: text,
                tags: tags,
                img: imgBase64,
                date: new Date().toLocaleDateString('ru-RU')
            });

            saveData();
            document.getElementById('entryTitle').value = '';
            document.getElementById('entryContent').value = '';
            document.getElementById('entryTags').value = '';
            document.getElementById('entryFile').value = '';
            imgPreview.style.display = 'none';
            imgPreview.src = '';
            switchTab('list');
        }

        function renderEntries() {
            const list = document.getElementById('entriesList');
            const search = document.getElementById('searchEntries').value.toLowerCase();

            const filtered = appData.entries.filter(e => 
                e.title.toLowerCase().includes(search) || 
                e.content.toLowerCase().includes(search)
            );

            list.innerHTML = filtered.map(e => `
                <div id="entry-${e.id}" class="export-card" style="margin-bottom: 10px;">
                    <div style="display:flex; justify-content:space-between; color:#888; font-size:12px; margin-bottom:10px;">
                        <strong>${e.title}</strong>
                        <span>${e.date}</span>
                    </div>
                    <p style="margin-bottom: 10px; line-height: 1.5;">${e.content}</p>
                    ${e.img ? `<img src="${e.img}" class="export-img" style="margin-bottom:10px;">` : ''}
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>${e.tags.map(t => `<span style="font-size:12px; color:#ffeb3b; margin-right:5px;">#${t}</span>`).join('')}</div>
                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="exportToPNG('entry-${e.id}', 'diary')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è (PNG)</button>
                    </div>
                </div>
            `).join('');
        }

        // –õ–û–ì–ò–ö–ê –ë–ê–ù–ö–ò
        function openAddMomentModal() { document.getElementById('addMomentModal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function saveMoment() {
            const text = document.getElementById('momentText').value;
            if (!text) return alert("–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å!");

            const selectedTags = Array.from(document.querySelectorAll('#momentTags .tag.selected')).map(t => t.textContent);
            const imgPreview = document.getElementById('momentImgPreview');
            const imgBase64 = imgPreview.style.display === 'block' ? imgPreview.src : null;

            appData.moments.push({
                id: Date.now(),
                text: text,
                tags: selectedTags,
                color: currentSelectedColor,
                img: imgBase64,
                date: new Date().toLocaleDateString('ru-RU')
            });

            saveData();
            renderFireflies();
            closeModal('addMomentModal');
            
            document.getElementById('momentText').value = '';
            document.getElementById('momentFile').value = '';
            imgPreview.style.display = 'none';
            imgPreview.src = '';
            document.querySelectorAll('#momentTags .tag').forEach(t => t.classList.remove('selected'));
        }

        function renderFireflies() {
            const container = document.getElementById('firefliesContainer');
            container.innerHTML = appData.moments.map((m, index) => `
                <div class="firefly" onclick="viewMoment(${index})" style="
                    background: ${m.color};
                    box-shadow: 0 0 10px ${m.color};
                    left: ${Math.random() * 80 + 10}%;
                    top: ${Math.random() * 80 + 10}%;
                    animation-delay: ${Math.random() * 2}s;
                "></div>
            `).join('');
        }

        function viewMoment(index) {
            const m = appData.moments[index];
            document.getElementById('viewMomentColor').style.background = m.color;
            document.getElementById('viewMomentColor').style.color = m.color; 
            document.getElementById('viewMomentDate').textContent = m.date;
            document.getElementById('viewMomentText').textContent = m.text;
            document.getElementById('viewMomentTags').innerHTML = m.tags.map(t => `<span class="tag" style="background:rgba(255,255,255,0.1)">${t}</span>`).join('');
            
            const imgEl = document.getElementById('viewMomentImg');
            if(m.img) {
                imgEl.src = m.img;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }

            document.getElementById('viewMomentModal').classList.add('active');
        }

        function showRandomHappyMoment() {
            if (appData.moments.length === 0) return alert("–ë–∞–Ω–∫–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å —Å–≤–µ—Ç–ª—è—á–∫–æ–≤!");
            const rnd = Math.floor(Math.random() * appData.moments.length);
            viewMoment(rnd);
        }

        function saveMood(moodName, color) {
            const today = new Date().toISOString().split('T')[0];
            appData.moodHistory[today] = { mood: moodName, color: color };
            saveData();
            showScreen('mainChoiceScreen');
        }

        // –≠–ö–°–ü–û–†–¢ –í PNG
        function exportToPNG(elementId, prefix) {
            const element = document.getElementById(elementId);
            
            // –ü—Ä—è—á–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –≤–Ω—É—Ç—Ä–∏ —ç–ª–µ–º–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
            const btn = element.querySelector('.btn');
            if (btn) btn.style.display = 'none';

            html2canvas(element, { backgroundColor: '#1a1a3e', scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `fireflies_${prefix}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                if (btn) btn.style.display = 'block';
            });
        }

        // –ö–ê–õ–ï–ù–î–ê–†–¨ –ò –ü–†–û–ß–ï–ï
        function updateStats() {
            document.getElementById('statTotalMoments').textContent = `–í—Å–µ–≥–æ —Å–≤–µ—Ç–ª—è—á–∫–æ–≤: ${appData.moments.length}`;
            document.getElementById('statTotalEntries').textContent = `–ó–∞–ø–∏—Å–µ–π –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ: ${appData.entries.length}`;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();

            const firstDay = new Date(year, month, 1).getDay();
            const startOffset = (firstDay === 0) ? 6 : firstDay - 1; 

            for (let i = 0; i < startOffset; i++) {
                grid.innerHTML += `<div class="cal-day" style="opacity:0.2;"></div>`;
            }

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const moodData = appData.moodHistory[dateStr];

                let content = `<div class="cal-day-name">${day}</div>`;
                if (moodData) content += `<div class="cal-icon" style="background:${moodData.color}; border-radius:50%; width:15px; height:15px; margin:auto; box-shadow: 0 0 10px ${moodData.color};"></div>`;
                grid.innerHTML += `<div class="cal-day">${content}</div>`;
            }
        }

        function renderAchievements() {
            const list = document.getElementById('achievementsList');
            list.innerHTML = achievementsList.map(a => {
                const unlocked = a.req();
                return `
                    <div class="achieve-box" style="opacity: ${unlocked ? 1 : 0.3}">
                        <div style="font-size:30px; margin-bottom:5px;">${unlocked ? a.icon : 'üîí'}</div>
                        <div style="font-weight:bold;">${a.title}</div>
                        <div style="font-size:10px; color:#888;">${a.desc}</div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>
